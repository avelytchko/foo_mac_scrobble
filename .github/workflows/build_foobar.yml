name: Build and test foo_mac_scrobble

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: macos-latest

    env:
      FOOBAR2000_VERSION: "2.25.3"
      FOOBAR_WAIT_SECS: 30

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install wget cmake ninja

      - name: Ensure Xcode is active
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Build plugin with Xcode
        working-directory: foobar2000/foo_mac_scrobble
        run: |
          mkdir -p build
          xcodebuild -project foo_mac_scrobble.xcodeproj \
            -scheme foo_mac_scrobble \
            -configuration Release \
            -derivedDataPath build \
            OTHER_CPLUSPLUSFLAGS="-DFOO_LASTFM_DEBUG_DEFAULT=1 -DFOO_LASTFM_CI_API_KEY='\"${{ secrets.LASTFM_API_KEY }}\"' -DFOO_LASTFM_CI_API_SECRET='\"${{ secrets.LASTFM_API_SECRET }}\"'"

      - name: Download foobar2000 for macOS
        run: |
          wget -q -O foobar2000.dmg "https://www.foobar2000.org/downloads/foobar2000-v${FOOBAR2000_VERSION}.dmg"
          hdiutil attach foobar2000.dmg -mountpoint /Volumes/foobar2000
          sudo cp -R "/Volumes/foobar2000/foobar2000.app" /Applications/
          hdiutil detach /Volumes/foobar2000
          rm -f foobar2000.dmg

      - name: Install built component into foobar2000
        run: |
          COMPONENT_SRC=$(find foobar2000/foo_mac_scrobble/build -name "foo_mac_scrobble.component" | head -n 1)
          PLUGINS_DIR="$HOME/Library/foobar2000-v2/user-components/foo_mac_scrobble"
          mkdir -p "$PLUGINS_DIR"
          cp -r "$COMPONENT_SRC" "$PLUGINS_DIR/"
          echo "‚úÖ Installed to $PLUGINS_DIR"
          ls -la "$PLUGINS_DIR"

      - name: Prepare Last.fm session
        run: |
          mkdir -p "$HOME/Library/foobar2000-v2"
          echo '${{ secrets.LASTFM_SESSION_JSON }}' > "$HOME/Library/foobar2000-v2/lastfm_session.json"
          echo "‚úÖ Session JSON written:"
          ls -l "$HOME/Library/foobar2000-v2/lastfm_session.json"

      - name: Prepare Last.fm queue
        run: |
          echo '${{ secrets.LASTFM_SCROBBLE_QUEUE_JSON }}' > "$HOME/Library/foobar2000-v2/lastfm_scrobble_queue.json"
          echo "‚úÖ Queue JSON written:"
          ls -l "$HOME/Library/foobar2000-v2/lastfm_scrobble_queue.json"

      - name: Print environment info
        run: |
          sw_vers
          uname -a
          echo "Xcode version:"
          xcodebuild -version
          echo "Home: $HOME"

      - name: üß™ Run foobar2000 self-test (Last.fm Scrobbler)
        run: |
          LOG_FILE="foobar.log"

          echo "üöÄ Launching foobar2000 in background..."
          /Applications/foobar2000.app/Contents/MacOS/foobar2000 --help > "$LOG_FILE" 2>&1 &
          FOOBAR_PID=$!

          # Wait a bit for foobar to initialize and log everything
          sleep ${FOOBAR_WAIT_SECS}

          echo "üßπ Stopping foobar2000..."
          kill "$FOOBAR_PID" 2>/dev/null || pkill foobar2000 || true

          echo ""
          echo "==== üìú Foobar2000 log output (tail) ===="
          cat "$LOG_FILE" || tail -n 50 "$LOG_FILE"
          echo "========================================="
          echo ""

          echo "üîç Checking for expected log patterns..."
          declare -A CHECKS=(
            ["API init"]="Last.fm: LastfmApi instance created"
            ["Session loaded"]="Last.fm: Session loaded from disk"
            ["Session validated"]="Last.fm: Session key validated"
            ["Authenticated"]="Last.fm Scrobbler: Authenticated as"
            ["Plugin ready"]="Last.fm Scrobbler: Initialized successfully"
            ["Queue loaded"]="Last.fm: Successfully loaded 10 tracks from queue file"
            ["Queue initialized"]="Last.fm: Queue initialized, 10 tracks loaded"
            ["Queue processing"]="Last.fm: Processing queue with 10 tracks"
            ["Queue scrobbled"]="Last.fm: Successfully scrobbled from queue"
            ["Queue processed"]="Last.fm: Processed 10 tracks this cycle"
            ["Queue saved"]="Last.fm: Successfully saved queue to disk"
          )

          FAILED=0
          for LABEL in "${!CHECKS[@]}"; do
            PATTERN="${CHECKS[$LABEL]}"
            if grep -q "$PATTERN" "$LOG_FILE"; then
              echo "‚úÖ $LABEL ‚Äî found"
            else
              echo "‚ùå $LABEL ‚Äî missing"
              FAILED=1
            fi
          done

          echo ""
          if [ "$FAILED" -eq 0 ]; then
            echo "üéâ All validation checks passed!"
          else
            echo "üî• One or more checks failed. Full log below:"
            cat "$LOG_FILE"
            exit 1
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: foobar-log
          path: foobar.log

